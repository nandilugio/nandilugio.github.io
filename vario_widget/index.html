<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Vario Widget</title>
  <style>
    * {    
      margin: 0 !important;
      padding: 0 !important;
    }
    body {
      background-color: #eee;
    }
  </style>
</head>

<body>
  <script>
    // TODO: remove
    const STUB_SKEWT_DATA = '{"dalrtops": [[0, 0, 0]], "uid": "zUiFTSuVvVHCoym", "wdir": [[-158.6, -158.6, -158.6, -158.6, -163.7, -164.3, -164.8, 177.1, 158.2, 153.1, 170.9, -156.6, -153.3, 112.0, 80.2, 61.6, 60.9, 49.9, 43.7, 43.3, 40.4, 28.9, 19.8, 13.6, 7.0, 2.5, 1.1, 0.1, -2.0, -5.1, -6.0, -4.9, -2.6, -0.4, 0.7, 1.3, 2.6, 3.9, 6.3, 8.5, 11.1, 13.4, 16.3, 19.7, 22.9, 25.7, 28.2, 30.3, 31.9, 33.5, 34.9, 36.1, 37.2, 38.1, 38.8, 39.5, 40.2, 40.9, 41.6, 42.2, 42.8, 43.4, 44.0, 44.7, 45.4, 45.9, 46.3, 46.5, 46.7, 46.9, 47.1, 47.2, 47.3, 47.4, 47.5, 47.6, 47.8, 47.9, 48.0, 48.1, 48.2, 48.2, 48.1, 48.1, 48.0, 48.0, 48.0, 48.0, 48.2, 48.3, 48.4, 48.6, 48.8, 49.0, 49.1, 49.3, 49.5, 49.6, 49.6, 49.6, 49.6, 49.6, 49.6, 49.7, 49.8, 49.9, 50.0, 50.1, 50.3, 50.3, 50.4, 50.5, 50.5, 50.6, 50.6, 50.7, 50.8, 50.8, 50.9, 50.9, 50.9, 50.9, 50.9, 50.9, 50.9, 50.9, 50.8, 50.7, 50.6, 50.5, 50.4, 50.3, 50.1, 50.0, 49.8, 49.7, 49.7, 50.2, 50.6, 51.1, 51.5, 51.9, 52.3, 52.7, 53.1, 53.4, 53.8, 54.1, 54.0, 54.0, 53.9, 53.8, 53.7, 53.6, 53.7, 53.8, 53.9, 54.0, 54.1, 54.3, 54.7, 55.2, 55.6, 56.0, 56.5, 56.7, 56.8, 56.9, 57.0, 57.0, 57.1, 57.3, 57.5, 57.7, 57.9, 58.1, 58.3, 58.5, 58.7, 58.9, 59.0, 59.2, 59.4, 59.5, 59.6, 59.7, 59.8, 59.9, 60.0, 60.1, 60.2, 60.3, 60.4, 60.5, 60.7, 61.0, 61.3, 61.6, 61.9, 62.1, 62.4, 62.5, 62.6, 62.7, 62.8, 62.9, 63.1, 63.3, 63.5, 63.8, 64.0, 64.2, 64.3, 64.1, 64.0]], "hgts": [700.0, 750.0, 800.0, 850.0, 900.0, 950.0, 1000.0, 1050.0, 1100.0, 1150.0, 1200.0, 1250.0, 1300.0, 1350.0, 1400.0, 1450.0, 1500.0, 1550.0, 1600.0, 1650.0, 1700.0, 1750.0, 1800.0, 1850.0, 1900.0, 1950.0, 2000.0, 2050.0, 2100.0, 2150.0, 2200.0, 2250.0, 2300.0, 2350.0, 2400.0, 2450.0, 2500.0, 2550.0, 2600.0, 2650.0, 2700.0, 2750.0, 2800.0, 2850.0, 2900.0, 2950.0, 3000.0, 3050.0, 3100.0, 3150.0, 3200.0, 3250.0, 3300.0, 3350.0, 3400.0, 3450.0, 3500.0, 3550.0, 3600.0, 3650.0, 3700.0, 3750.0, 3800.0, 3850.0, 3900.0, 3950.0, 4000.0, 4050.0, 4100.0, 4150.0, 4200.0, 4250.0, 4300.0, 4350.0, 4400.0, 4450.0, 4500.0, 4550.0, 4600.0, 4650.0, 4700.0, 4750.0, 4800.0, 4850.0, 4900.0, 4950.0, 5000.0, 5050.0, 5100.0, 5150.0, 5200.0, 5250.0, 5300.0, 5350.0, 5400.0, 5450.0, 5500.0, 5550.0, 5600.0, 5650.0, 5700.0, 5750.0, 5800.0, 5850.0, 5900.0, 5950.0, 6000.0, 6050.0, 6100.0, 6150.0, 6200.0, 6250.0, 6300.0, 6350.0, 6400.0, 6450.0, 6500.0, 6550.0, 6600.0, 6650.0, 6700.0, 6750.0, 6800.0, 6850.0, 6900.0, 6950.0, 7000.0, 7050.0, 7100.0, 7150.0, 7200.0, 7250.0, 7300.0, 7350.0, 7400.0, 7450.0, 7500.0, 7550.0, 7600.0, 7650.0, 7700.0, 7750.0, 7800.0, 7850.0, 7900.0, 7950.0, 8000.0, 8050.0, 8100.0, 8150.0, 8200.0, 8250.0, 8300.0, 8350.0, 8400.0, 8450.0, 8500.0, 8550.0, 8600.0, 8650.0, 8700.0, 8750.0, 8800.0, 8850.0, 8900.0, 8950.0, 9000.0, 9050.0, 9100.0, 9150.0, 9200.0, 9250.0, 9300.0, 9350.0, 9400.0, 9450.0, 9500.0, 9550.0, 9600.0, 9650.0, 9700.0, 9750.0, 9800.0, 9850.0, 9900.0, 9950.0, 10000.0, 10050.0, 10100.0, 10150.0, 10200.0, 10250.0, 10300.0, 10350.0, 10400.0, 10450.0, 10500.0, 10550.0, 10600.0, 10650.0, 10700.0, 10750.0, 10800.0, 10850.0, 10900.0, 10950.0, 11000.0, 11050.0, 11100.0, 11150.0, 11200.0, 11250.0, 11300.0, 11350.0, 11400.0], "press": [[936, 931, 925, 920, 914, 909, 903, 897, 892, 886, 881, 876, 870, 865, 860, 855, 849, 844, 839, 834, 829, 824, 819, 814, 810, 805, 800, 795, 790, 786, 781, 776, 772, 767, 762, 758, 753, 749, 744, 740, 735, 731, 726, 722, 717, 713, 709, 704, 700, 696, 692, 687, 683, 679, 675, 671, 667, 663, 658, 654, 650, 646, 642, 638, 634, 631, 627, 623, 619, 615, 611, 608, 604, 600, 596, 593, 589, 585, 582, 578, 574, 571, 567, 564, 560, 557, 553, 550, 546, 543, 540, 536, 533, 529, 526, 523, 519, 516, 513, 510, 506, 503, 500, 497, 494, 490, 487, 484, 481, 478, 475, 472, 469, 466, 463, 460, 457, 454, 451, 448, 445, 442, 439, 436, 433, 431, 428, 425, 422, 419, 417, 414, 411, 409, 406, 403, 400, 398, 395, 392, 390, 387, 385, 382, 380, 377, 374, 372, 369, 367, 365, 362, 360, 357, 355, 352, 350, 348, 345, 343, 340, 338, 336, 333, 331, 329, 327, 324, 322, 320, 318, 316, 313, 311, 309, 307, 305, 302, 300, 298, 296, 294, 292, 290, 288, 286, 284, 282, 280, 278, 276, 274, 272, 270, 268, 266, 264, 262, 260, 259, 257, 255, 253, 251, 249, 247, 246, 244, 242, 240, 239, 237, 235, 233, 232]], "tmps": [[27.49, 27.0, 26.52, 26.05, 25.62, 25.18, 24.76, 24.34, 23.93, 23.54, 23.22, 22.92, 22.65, 22.38, 22.14, 21.93, 21.78, 21.62, 21.43, 21.23, 21.03, 20.78, 20.53, 20.28, 20.02, 19.71, 19.39, 19.08, 18.75, 18.44, 18.13, 17.83, 17.53, 17.23, 16.92, 16.62, 16.29, 15.95, 15.59, 15.22, 14.82, 14.43, 14.05, 13.67, 13.3, 12.93, 12.61, 12.34, 12.1, 11.86, 11.65, 11.44, 11.24, 11.05, 10.85, 10.63, 10.35, 10.07, 9.76, 9.44, 9.09, 8.72, 8.34, 7.96, 7.57, 7.19, 6.81, 6.43, 6.05, 5.68, 5.3, 4.93, 4.54, 4.16, 3.77, 3.38, 2.99, 2.6, 2.2, 1.81, 1.43, 1.1, 0.78, 0.47, 0.16, -0.15, -0.43, -0.7, -0.96, -1.22, -1.48, -1.76, -2.1, -2.45, -2.8, -3.15, -3.5, -3.84, -4.18, -4.51, -4.85, -5.19, -5.52, -5.85, -6.17, -6.5, -6.82, -7.15, -7.46, -7.77, -8.08, -8.39, -8.71, -9.01, -9.27, -9.52, -9.78, -10.03, -10.29, -10.57, -10.89, -11.21, -11.54, -11.86, -12.18, -12.51, -12.85, -13.19, -13.53, -13.87, -14.21, -14.54, -14.88, -15.21, -15.55, -15.88, -16.23, -16.58, -16.94, -17.29, -17.65, -18.0, -18.29, -18.54, -18.79, -19.03, -19.28, -19.53, -19.86, -20.2, -20.53, -20.87, -21.21, -21.55, -21.94, -22.33, -22.72, -23.11, -23.5, -23.88, -24.24, -24.59, -24.94, -25.3, -25.65, -25.99, -26.31, -26.62, -26.94, -27.26, -27.58, -27.87, -28.15, -28.43, -28.72, -29.0, -29.28, -29.64, -30.01, -30.37, -30.74, -31.11, -31.48, -31.8, -32.12, -32.45, -32.77, -33.09, -33.42, -33.76, -34.1, -34.44, -34.78, -35.12, -35.48, -35.89, -36.29, -36.7, -37.1, -37.51, -37.92, -38.34, -38.77, -39.19, -39.61, -40.04, -40.45, -40.86, -41.26, -41.67, -42.07, -42.48, -42.89, -43.29, -43.7]], "dates": [1690405200.0], "dps": [[12.1, 12.0, 11.9, 11.8, 11.8, 11.9, 12.0, 12.1, 12.2, 12.3, 12.4, 12.4, 12.5, 12.5, 12.5, 12.3, 11.8, 11.1, 10.3, 9.2, 8.1, 7.4, 6.7, 6.0, 5.5, 5.0, 4.6, 4.3, 4.3, 4.1, 3.7, 3.2, 2.4, 1.3, 0.2, -0.8, -1.7, -2.5, -2.9, -2.7, -2.1, -1.5, -0.8, 0.0, 0.8, 1.5, 1.8, 1.9, 1.8, 1.7, 1.3, 0.8, 0.0, -0.7, -1.6, -2.6, -3.5, -4.4, -5.2, -6.1, -6.7, -7.3, -7.7, -8.1, -8.5, -8.8, -9.1, -9.3, -9.5, -9.8, -10.0, -10.3, -10.5, -10.7, -11.0, -11.2, -11.6, -12.0, -12.5, -12.9, -13.5, -14.4, -15.8, -17.2, -18.7, -20.3, -21.8, -23.1, -24.5, -26.0, -27.7, -29.2, -29.7, -30.0, -30.3, -30.6, -30.8, -30.9, -30.7, -30.6, -30.5, -30.5, -30.4, -30.4, -30.3, -30.3, -30.3, -30.3, -30.3, -30.4, -30.5, -30.6, -30.7, -30.8, -30.8, -30.8, -30.7, -30.7, -30.7, -30.5, -30.1, -29.7, -29.4, -29.1, -28.8, -28.7, -28.7, -28.6, -28.6, -28.6, -28.7, -29.2, -29.8, -30.4, -31.0, -31.6, -32.2, -32.8, -33.5, -34.1, -34.8, -35.5, -36.0, -36.3, -36.7, -37.1, -37.4, -37.8, -38.0, -38.2, -38.4, -38.6, -38.8, -39.1, -39.5, -39.9, -40.3, -40.8, -41.2, -41.7, -42.3, -43.0, -43.6, -44.3, -45.0, -45.8, -46.8, -47.9, -49.0, -50.2, -51.4, -52.1, -52.6, -53.1, -53.6, -54.1, -54.7, -54.7, -54.8, -54.8, -54.9, -54.9, -55.0, -55.0, -55.0, -54.9, -54.9, -55.0, -55.1, -55.7, -56.4, -57.0, -57.7, -58.4, -58.9, -59.2, -59.4, -59.6, -59.8, -60.1, -60.2, -60.3, -60.4, -60.5, -60.6, -60.7, -60.7, -60.7, -60.7, -60.7, -60.7, -60.8, -60.8, -60.8, -60.8]], "shgt": 737.0, "spress": [900.7], "wspd": [[1.0, 1.0, 1.0, 1.0, 1.0, 0.9, 0.8, 0.7, 0.7, 0.4, 0.2, 0.2, 0.1, 0.2, 0.3, 0.4, 0.4, 0.4, 0.6, 0.7, 0.8, 0.9, 1.1, 1.1, 1.3, 1.4, 1.6, 1.8, 2.0, 2.2, 2.5, 2.8, 3.1, 3.4, 3.7, 4.0, 4.2, 4.5, 4.8, 5.1, 5.5, 5.9, 6.2, 6.6, 7.0, 7.5, 8.0, 8.7, 9.3, 9.9, 10.6, 11.2, 11.7, 12.3, 12.8, 13.3, 13.9, 14.4, 14.9, 15.4, 15.8, 16.2, 16.6, 17.0, 17.4, 17.8, 18.3, 18.7, 19.1, 19.5, 19.9, 20.2, 20.5, 20.8, 21.1, 21.3, 21.5, 21.5, 21.6, 21.7, 21.7, 21.6, 21.5, 21.3, 21.2, 21.1, 20.9, 20.8, 20.6, 20.4, 20.2, 20.0, 19.8, 19.5, 19.2, 19.0, 18.7, 18.5, 18.3, 18.2, 18.0, 17.8, 17.7, 17.5, 17.4, 17.3, 17.2, 17.1, 17.0, 17.1, 17.1, 17.1, 17.1, 17.2, 17.4, 17.6, 17.9, 18.2, 18.4, 18.7, 18.9, 19.2, 19.5, 19.7, 20.0, 20.2, 20.3, 20.4, 20.5, 20.7, 20.8, 20.8, 20.8, 20.8, 20.8, 20.8, 20.8, 20.9, 21.0, 21.1, 21.1, 21.2, 21.3, 21.4, 21.5, 21.5, 21.6, 21.7, 21.8, 21.9, 22.0, 22.1, 22.2, 22.3, 22.4, 22.5, 22.6, 22.7, 22.8, 22.8, 22.7, 22.6, 22.5, 22.4, 22.3, 22.2, 22.0, 21.9, 21.8, 21.6, 21.5, 21.4, 21.3, 21.3, 21.2, 21.1, 21.1, 21.0, 20.8, 20.7, 20.6, 20.5, 20.4, 20.4, 20.5, 20.5, 20.6, 20.7, 20.7, 20.6, 20.4, 20.3, 20.2, 20.0, 19.9, 19.9, 19.9, 19.8, 19.8, 19.8, 19.8, 19.8, 19.7, 19.7, 19.7, 19.7, 19.7, 19.8, 19.8, 19.9, 20.0, 20.1, 20.2, 20.3, 20.4]], "tmp2m": [25.23]}';
  </script>

  <pre id="errors" style="color: red; background-color: orange;"></pre>

  <!-- We'll use the whole browser viewport height. viewBox will be set dinamically depending on the number of barbs to display. -->
  <svg version="1.1" xmlns="http://www.w3.org/2000/svg" id="graph" height="100vh" style="background-color: white;">
    <style>
      #altitude {
        stroke: darkblue;
        stroke-width: 5;
      }
      #ground {
        stroke-width: 0;
        fill: brown;
      }
      .barb {
        fill: none;
        stroke: black;
        stroke-width: 5;
        stroke-linecap: round;
      }
    </style>
    <defs>
      <circle id="barb0" class="barb" cx=50 cy=50 r=10 />
      <path id="barb5" class="barb" d="M 50 80 L 50 10 M 50 70 L 40 75"/>
      <path id="barb10" class="barb" d="M 50 80 L 50 10 M 50 80 L 30 90"/>
      <path id="barb15" class="barb" d="M 50 80 L 50 10 M 50 80 L 30 90 M 50 70 L 40 75"/>
      <path id="barb20" class="barb" d="M 50 80 L 50 10 M 50 80 L 30 90 M 50 70 L 30 80"/>
      <path id="barb25" class="barb" d="M 50 80 L 50 10 M 50 80 L 30 90 M 50 70 L 30 80 M 50 60 L 40 65"/>
      <path id="barb30" class="barb" d="M 50 80 L 50 10 M 50 80 L 30 90 M 50 70 L 30 80 M 50 60 L 30 70"/>
      <path id="barb35" class="barb" d="M 50 80 L 50 10 M 50 80 L 30 90 M 50 70 L 30 80 M 50 60 L 30 70 M 50 50 L 40 55"/>
      <path id="barb40" class="barb" d="M 50 80 L 50 10 M 50 80 L 30 90 M 50 70 L 30 80 M 50 60 L 30 70 M 50 50 L 30 60"/>
      <path id="barb45" class="barb" d="M 50 80 L 50 10 M 50 80 L 30 90 M 50 70 L 30 80 M 50 60 L 30 70 M 50 50 L 30 60 M 50 40 L 40 45"/>
      <path id="barb50" class="barb" d="M 50 80 L 50 10 M 50 80 L 30 80 L 50 65"/>
    </defs>
    <rect id="ground" x=0 y=1000 width=100 height=1000 />
    <line id="altitude" x1=0 y1=0 x2=100 y2=0 />
  </svg>

  <script type="module">

    // Utils /////////////////////////////////////////////////////////////////

    function sum(arr) {
      return arr.reduce((acc, n) => acc + n, 0);
    }
 
    function average(arr) {
      return sum(arr) / arr.length;
    }

    function degToRad(deg) {
      return deg * (Math.PI/180)
    }

    // Adapted from https://rosettacode.org/wiki/Averages/Mean_angle
    function meanAngleDeg(a) {
      const floatMean = 180 / Math.PI * Math.atan2(
        sum(a.map(degToRad).map(Math.sin)) / a.length,
        sum(a.map(degToRad).map(Math.cos)) / a.length
      );
      // my additions
      const normFloatMean = ((floatMean % 360) + 360) % 360; // constrain to be between 0 and 360
      return Math.round(normFloatMean);
    }

    // From https://stackoverflow.com/questions/18883601/function-to-calculate-distance-between-two-coordinates
    function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
      var R = 6371; // Radius of the earth in km
      var dLat = degToRad(lat2-lat1);
      var dLon = degToRad(lon2-lon1); 
      var a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(degToRad(lat1)) * Math.cos(degToRad(lat2)) * 
        Math.sin(dLon/2) * Math.sin(dLon/2)
        ; 
      var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
      var d = R * c; // Distance in km
      return d;
    }

    function getQueryParam(paramName) {
      const queryParams = new URLSearchParams(window.location.search);
      const value = queryParams.get(paramName);
      if (!(typeof value === 'string' || value instanceof String)) {
        throw new Error(`Query parameter '${paramName}' is required.`);
      }
      return value;       
    }

    // Geopos ////////////////////////////////////////////////////////////////

    function getGeopos() {
      return new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(resolve, reject, {
          enableHighAccuracy: true,
          maximumAge: 10000
        });
      });
    }

    function onGeoposDepartFrom(lat, long, distKm, fun) {
      navigator.geolocation.watchPosition((geopos) => {
        const newCoords = geopos.coords;
        if (getDistanceFromLatLonInKm(lat, long, newCoords.latitude, newCoords.longitude) >= distKm) {
          fun(geopos);
        }
      }, (error) => {
        throw error;
      }, {
        enableHighAccuracy: true,
        maximumAge: 10000
      });
    }

    // UI ////////////////////////////////////////////////////////////////////
    // topAltitude = numBarbs * barbAltRange
    // viewBoxHeight = numBarbs * 100

    function yCoordFromAltitude(altitude, topAltitude, viewBoxHeight) {
      return (topAltitude - altitude) * (viewBoxHeight / topAltitude)
    }

    function displayBarbs(barbDisplayData) {
      barbDisplayData.forEach((barbDatum, barbIdx) => {
        displayBarb(barbIdx, barbDatum.meanWindSpeed, barbDatum.meanWindDir);
      });
    }

    function displayBarb(barbIdx, windSpeed, windDirection) {
      const graph = document.getElementById("graph");
      const barb = document.createElementNS("http://www.w3.org/2000/svg", "use");
      const y = barbIdx * 100;
      const windSpeedClass = `#barb${Math.min(Math.round(windSpeed / 5) * 5, 50)}`;
      barb.setAttributeNS(null, "x", 0);
      barb.setAttributeNS(null, "y", y);
      barb.setAttributeNS(null, "transform", `rotate(${windDirection} 50 ${y + 50})`);
      barb.setAttributeNS(null, "href", windSpeedClass);
      graph.appendChild(barb);
    }

    function updateAltitude(altitude, topAltitude, viewBoxHeight) {
      const altMarker = document.getElementById("altitude");
      const y = yCoordFromAltitude(altitude, topAltitude, viewBoxHeight);
      altMarker.setAttributeNS(null, "y1", y);
      altMarker.setAttributeNS(null, "y2", y);
    }

    function updateGroundHeight(groundAltitude, topAltitude, viewBoxHeight) {
      const groundBox = document.getElementById("ground");
      const y = yCoordFromAltitude(groundAltitude, topAltitude, viewBoxHeight);
      groundBox.setAttributeNS(null, "y", y);
    }

    // XCSkies ///////////////////////////////////////////////////////////////

    async function fetchXcskiesSkewTData(time, lat, lon, model) {
      const pad2 = (n) => ("0" + n).slice(-2);
      const dateStr = `${time.getUTCFullYear()}${pad2(time.getUTCMonth()+1)}${pad2(time.getDate())}`;
      const hourStr = pad2(time.getUTCHours());
      const url = `https://n3.xcskies.com/skewt/${model}/${dateStr}/${hourStr}/00?lat=${lat}&lon=${lon}&single=1&callback=d3.jsonp.zUiFTSuVvVHCoym`;
      // const response = await fetch(url);
      // const body = await response.text();
      // const jsonData = body.slice(25, -1); // Remove JSONP wrapper function
      const jsonData = STUB_SKEWT_DATA;
      return JSON.parse(jsonData);
    }

    function xcskiesSkewTDataToDisplayData(xcskiesSkewtData, numBarbs, barbAltRange) {
      const topAltitude = numBarbs * barbAltRange;

      // Iterate on all datapoints to get data by barb
      const rawBarbData = [];
      xcskiesSkewtData.hgts.every((altitude, i) => {
        if (altitude >= topAltitude) return false;
        if (altitude <= 0) return false;
        const barbIdx = Math.floor(numBarbs - (altitude / barbAltRange)); // 0 based idx from top (SVG coords style)
        rawBarbData[barbIdx] ||= {windSpeeds: [], windDirs: []};
        rawBarbData[barbIdx].windSpeeds.push(xcskiesSkewtData.wspd[0][i] * 1.852); // in kph (orig in knots)
        rawBarbData[barbIdx].windDirs.push(xcskiesSkewtData.wdir[0][i]); // in degrees
        return true;
      });

      // Iterate by barb and calculate metadata
      const barbData = rawBarbData.map((barbDatum, position) => {
        return {
          meanWindSpeed: average(barbDatum.windSpeeds),
          meanWindDir: meanAngleDeg(barbDatum.windDirs)
        }
      });

      return {
        barbData,
        groundHeight: xcskiesSkewtData.shgt
      };
    }

    // Main //////////////////////////////////////////////////////////////////

    try {
      // Get URL query params
      // General
      const topAltitude = parseInt(getQueryParam("top")); // Top altitude (amsl) displayed eg. 5000
      const numBarbs = parseInt(getQueryParam("barbs")); // Number of barbs to display eg. 10
      // XCSkies
      const model = getQueryParam("model"); // Meteo model eg. iconeu, gfs...

      // Initialize graph
      const viewBoxHeight = 100 * numBarbs; // 100 units per barb in vp height
      const graph = document.getElementById("graph");
      graph.setAttributeNS(null, "viewBox", `0 0 100 ${viewBoxHeight}`);

      // Get current geoposition
      const geopos = await getGeopos();
      const coords = geopos.coords;

      // Retrieve and parse SkewT data
      const barbAltRange = topAltitude / numBarbs;
      const xcskiesSkewTData = await fetchXcskiesSkewTData(new Date(), coords.latitude, coords.longitude, model);
      const displayData = xcskiesSkewTDataToDisplayData(xcskiesSkewTData, numBarbs, barbAltRange)

      // Display all data
      displayBarbs(displayData.barbData);
      updateAltitude(coords.altitude, topAltitude, viewBoxHeight);
      updateGroundHeight(displayData.groundHeight, topAltitude, viewBoxHeight);

      // Set reload strategies to refresh displayed data
      const reload = ()=>{ window.location.reload(); };
      onGeoposDepartFrom(coords.latitude, coords.longitude, 1, reload);
      setTimeout(reload, 40 * 60 * 1000);

    } catch (error) {
      const div = document.getElementById("errors");
      div.innerHTML += error.message;
      throw error;
    }
  </script>
</body>
</html>

