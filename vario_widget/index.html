<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Vario Widget</title>
  <style>
    * {    
      margin: 0 !important;
      padding: 0 !important;
    }
    body {
      background-color: #eee;
    }
  </style>
</head>

<body>
  <script>
    // TODO: remove
    const STUB_SKEWT_DATA = '{"dalrtops": [[1650.0, 830.2, 21.92]], "uid": "dTlViufMFHXvjXH", "wdir": [[112.3, 112.5, 110.2, 85.1, 48.1, 31.7, 29.9, 28.9, 28.1, 30.6, 32.7, 35.2, 40.8, 45.3, 48.7, 50.6, 52.1, 53.5, 54.7, 54.9, 55.0, 55.2, 55.4, 55.9, 56.3, 56.8, 57.1, 57.2, 57.4, 57.5, 57.7, 58.0, 58.3, 58.7, 59.0, 59.3, 59.7, 60.0, 60.4, 60.8, 61.3, 62.0, 62.6, 63.3, 63.9, 64.5, 65.1, 65.7, 66.3, 66.8, 67.4, 67.6, 67.8, 68.1, 68.3, 68.6, 68.7, 68.6, 68.6, 68.6, 68.5, 68.5, 68.4, 68.1, 67.9, 67.6, 67.4, 67.2, 67.0, 67.0, 67.0, 67.0, 67.0, 67.0, 67.0, 66.9, 66.7, 66.6, 66.4, 66.3, 66.1, 65.9, 65.8, 65.7, 65.7, 65.6, 65.5, 65.4, 65.3, 65.2, 65.0, 64.9, 64.7, 64.6, 64.4, 64.3, 64.2, 64.5, 64.7, 64.9, 65.2, 65.5, 65.7, 66.0, 65.5, 64.8, 64.1, 63.4, 62.7, 61.9, 61.2, 60.5, 60.7, 60.8, 60.9, 61.0, 61.1, 61.3, 61.4, 61.6, 62.0, 62.3, 62.6, 63.0, 63.3, 63.7, 64.0, 63.7, 63.2, 62.8, 62.4, 61.9, 61.5, 61.1, 60.9, 61.5, 62.1, 62.8, 63.4, 64.0, 64.7, 65.3, 66.0, 66.7, 67.5, 68.2, 68.9, 69.6, 70.3, 71.0, 71.2, 71.3, 71.4, 71.4, 71.5, 71.6, 71.6, 71.7, 71.6, 71.5, 71.4, 71.4, 71.3, 71.2, 71.1, 71.1, 71.4, 71.7, 72.0, 72.2, 72.5, 72.8, 73.1, 73.5, 74.1, 74.7, 75.4, 76.0, 76.6, 77.2, 77.8, 78.2, 78.4, 78.7, 78.9, 79.1, 79.4, 79.6, 79.8, 80.0, 80.1, 80.2, 80.4, 80.5, 80.7, 80.8, 80.9, 80.9, 80.8, 80.7, 80.6, 80.5, 80.4, 80.4]], "hgts": [1250.0, 1300.0, 1350.0, 1400.0, 1450.0, 1500.0, 1550.0, 1600.0, 1650.0, 1700.0, 1750.0, 1800.0, 1850.0, 1900.0, 1950.0, 2000.0, 2050.0, 2100.0, 2150.0, 2200.0, 2250.0, 2300.0, 2350.0, 2400.0, 2450.0, 2500.0, 2550.0, 2600.0, 2650.0, 2700.0, 2750.0, 2800.0, 2850.0, 2900.0, 2950.0, 3000.0, 3050.0, 3100.0, 3150.0, 3200.0, 3250.0, 3300.0, 3350.0, 3400.0, 3450.0, 3500.0, 3550.0, 3600.0, 3650.0, 3700.0, 3750.0, 3800.0, 3850.0, 3900.0, 3950.0, 4000.0, 4050.0, 4100.0, 4150.0, 4200.0, 4250.0, 4300.0, 4350.0, 4400.0, 4450.0, 4500.0, 4550.0, 4600.0, 4650.0, 4700.0, 4750.0, 4800.0, 4850.0, 4900.0, 4950.0, 5000.0, 5050.0, 5100.0, 5150.0, 5200.0, 5250.0, 5300.0, 5350.0, 5400.0, 5450.0, 5500.0, 5550.0, 5600.0, 5650.0, 5700.0, 5750.0, 5800.0, 5850.0, 5900.0, 5950.0, 6000.0, 6050.0, 6100.0, 6150.0, 6200.0, 6250.0, 6300.0, 6350.0, 6400.0, 6450.0, 6500.0, 6550.0, 6600.0, 6650.0, 6700.0, 6750.0, 6800.0, 6850.0, 6900.0, 6950.0, 7000.0, 7050.0, 7100.0, 7150.0, 7200.0, 7250.0, 7300.0, 7350.0, 7400.0, 7450.0, 7500.0, 7550.0, 7600.0, 7650.0, 7700.0, 7750.0, 7800.0, 7850.0, 7900.0, 7950.0, 8000.0, 8050.0, 8100.0, 8150.0, 8200.0, 8250.0, 8300.0, 8350.0, 8400.0, 8450.0, 8500.0, 8550.0, 8600.0, 8650.0, 8700.0, 8750.0, 8800.0, 8850.0, 8900.0, 8950.0, 9000.0, 9050.0, 9100.0, 9150.0, 9200.0, 9250.0, 9300.0, 9350.0, 9400.0, 9450.0, 9500.0, 9550.0, 9600.0, 9650.0, 9700.0, 9750.0, 9800.0, 9850.0, 9900.0, 9950.0, 10000.0, 10050.0, 10100.0, 10150.0, 10200.0, 10250.0, 10300.0, 10350.0, 10400.0, 10450.0, 10500.0, 10550.0, 10600.0, 10650.0, 10700.0, 10750.0, 10800.0, 10850.0, 10900.0, 10950.0, 11000.0, 11050.0, 11100.0, 11150.0, 11200.0, 11250.0, 11300.0, 11350.0, 11400.0], "press": [[871, 866, 861, 856, 850, 845, 840, 835, 830, 825, 820, 815, 811, 806, 801, 796, 791, 787, 782, 777, 773, 768, 763, 759, 754, 750, 745, 741, 736, 732, 727, 723, 718, 714, 710, 705, 701, 697, 693, 688, 684, 680, 676, 672, 667, 663, 659, 655, 651, 647, 643, 639, 635, 631, 627, 623, 619, 615, 611, 608, 604, 600, 596, 592, 589, 585, 581, 577, 574, 570, 566, 563, 559, 555, 552, 548, 545, 541, 538, 534, 531, 527, 524, 520, 517, 514, 510, 507, 503, 500, 497, 494, 491, 487, 484, 481, 478, 475, 472, 468, 465, 462, 459, 456, 453, 450, 447, 444, 441, 438, 435, 432, 430, 427, 424, 421, 418, 415, 412, 410, 407, 404, 401, 399, 396, 393, 390, 388, 385, 383, 380, 377, 375, 372, 370, 367, 365, 362, 360, 357, 355, 352, 350, 347, 345, 342, 340, 338, 335, 333, 331, 328, 326, 324, 321, 319, 317, 315, 312, 310, 308, 306, 304, 302, 299, 297, 295, 293, 291, 289, 287, 285, 282, 280, 278, 276, 274, 272, 270, 268, 266, 264, 262, 261, 259, 257, 255, 253, 251, 249, 247, 245, 244, 242, 240, 238, 236, 235, 233, 231, 229, 228, 226, 224]], "tmps": [[26.65, 25.91, 25.21, 24.62, 24.06, 23.5, 22.96, 22.43, 21.92, 21.51, 21.16, 20.88, 20.63, 20.33, 19.93, 19.53, 19.17, 18.83, 18.53, 18.31, 18.09, 17.85, 17.6, 17.34, 17.08, 16.81, 16.54, 16.25, 15.91, 15.58, 15.23, 14.84, 14.43, 14.02, 13.61, 13.18, 12.73, 12.27, 11.82, 11.37, 10.9, 10.42, 9.95, 9.47, 9.0, 8.53, 8.07, 7.61, 7.16, 6.7, 6.24, 5.79, 5.35, 4.9, 4.45, 4.01, 3.57, 3.15, 2.73, 2.31, 1.89, 1.47, 1.04, 0.59, 0.14, -0.3, -0.75, -1.2, -1.65, -2.11, -2.57, -3.03, -3.49, -3.94, -4.4, -4.84, -5.26, -5.68, -6.11, -6.53, -6.95, -7.38, -7.81, -8.24, -8.67, -9.11, -9.54, -9.97, -10.4, -10.77, -11.11, -11.45, -11.79, -12.13, -12.47, -12.81, -13.17, -13.56, -13.96, -14.35, -14.75, -15.14, -15.54, -15.94, -16.23, -16.49, -16.74, -17.0, -17.26, -17.51, -17.77, -18.05, -18.48, -18.91, -19.33, -19.76, -20.19, -20.62, -21.04, -21.38, -21.65, -21.92, -22.19, -22.46, -22.73, -23.01, -23.28, -23.49, -23.7, -23.91, -24.11, -24.32, -24.53, -24.74, -24.97, -25.29, -25.6, -25.91, -26.22, -26.53, -26.84, -27.15, -27.42, -27.66, -27.9, -28.13, -28.37, -28.6, -28.84, -29.08, -29.43, -29.82, -30.21, -30.59, -30.98, -31.36, -31.75, -32.13, -32.54, -32.94, -33.34, -33.74, -34.14, -34.54, -34.94, -35.35, -35.79, -36.22, -36.65, -37.09, -37.52, -37.96, -38.39, -38.83, -39.28, -39.72, -40.17, -40.62, -41.06, -41.51, -41.96, -42.35, -42.71, -43.06, -43.42, -43.77, -44.13, -44.48, -44.84, -45.21, -45.59, -45.97, -46.35, -46.73, -47.12, -47.5, -47.88, -48.27, -48.67, -49.06, -49.46, -49.85, -50.25, -50.65]], "dates": [1660478400.0], "dps": [[13.2, 12.9, 12.6, 12.4, 12.2, 11.9, 11.7, 11.5, 11.2, 10.8, 10.3, 9.8, 9.4, 9.0, 8.8, 8.6, 8.1, 7.6, 7.0, 6.0, 5.1, 4.2, 3.4, 2.5, 1.7, 1.0, 0.2, -0.5, -1.0, -1.4, -1.9, -2.1, -2.2, -2.4, -2.5, -2.6, -2.6, -2.7, -2.8, -2.9, -2.9, -2.9, -3.0, -3.0, -3.1, -3.2, -3.3, -3.5, -3.6, -3.7, -3.9, -4.0, -4.2, -4.3, -4.5, -4.7, -4.8, -4.9, -5.1, -5.2, -5.4, -5.6, -5.7, -5.9, -6.1, -6.3, -6.5, -6.7, -6.9, -7.2, -7.5, -7.7, -8.0, -8.3, -8.6, -8.9, -9.3, -9.7, -10.1, -10.5, -10.9, -11.3, -11.7, -12.0, -12.4, -12.7, -13.1, -13.4, -13.7, -14.0, -14.3, -14.6, -14.8, -15.1, -15.3, -15.6, -15.9, -16.5, -17.1, -17.7, -18.3, -19.0, -19.6, -20.2, -21.2, -22.4, -23.7, -25.0, -26.5, -28.1, -29.9, -31.7, -32.3, -33.0, -33.7, -34.4, -35.1, -35.9, -36.6, -37.3, -38.0, -38.7, -39.5, -40.3, -41.1, -41.9, -42.8, -43.1, -43.4, -43.7, -44.0, -44.3, -44.6, -44.9, -45.2, -45.4, -45.5, -45.7, -45.9, -46.1, -46.3, -46.4, -46.7, -47.1, -47.4, -47.8, -48.1, -48.5, -48.9, -49.2, -49.5, -49.7, -50.0, -50.2, -50.5, -50.7, -51.0, -51.2, -51.4, -51.6, -51.8, -52.0, -52.2, -52.4, -52.6, -52.9, -53.0, -53.2, -53.4, -53.6, -53.8, -54.1, -54.3, -54.4, -54.6, -54.7, -54.8, -55.0, -55.1, -55.3, -55.4, -55.7, -56.1, -56.5, -56.8, -57.2, -57.6, -57.9, -58.3, -58.7, -59.1, -59.5, -59.8, -60.2, -60.6, -61.0, -61.4, -61.8, -62.2, -62.6, -62.9, -63.3, -63.7, -64.1]], "shgt": 1298.0, "spress": [917.0], "wspd": [[3.4, 3.4, 3.3, 2.9, 3.5, 4.8, 5.4, 5.9, 6.4, 6.9, 7.5, 8.1, 9.0, 10.1, 11.2, 11.8, 12.3, 12.8, 13.3, 13.9, 14.5, 15.1, 15.5, 15.8, 16.0, 16.3, 16.5, 16.7, 16.8, 16.9, 17.1, 17.1, 17.0, 17.0, 17.0, 16.9, 16.9, 16.8, 16.8, 16.7, 16.7, 16.9, 17.0, 17.1, 17.2, 17.4, 17.5, 17.6, 17.7, 17.9, 18.0, 18.2, 18.4, 18.6, 18.8, 19.0, 19.3, 19.7, 20.1, 20.5, 21.0, 21.4, 21.8, 22.0, 22.3, 22.6, 22.8, 23.1, 23.4, 23.7, 24.0, 24.3, 24.6, 24.9, 25.2, 25.3, 25.3, 25.4, 25.5, 25.5, 25.6, 25.6, 25.7, 25.8, 25.9, 26.1, 26.2, 26.3, 26.4, 26.3, 26.2, 26.0, 25.9, 25.7, 25.6, 25.5, 25.3, 25.2, 25.0, 24.9, 24.8, 24.6, 24.5, 24.4, 24.2, 24.1, 23.9, 23.8, 23.7, 23.5, 23.4, 23.3, 23.3, 23.3, 23.2, 23.2, 23.2, 23.1, 23.1, 23.1, 23.0, 22.9, 22.8, 22.8, 22.7, 22.6, 22.6, 22.5, 22.4, 22.3, 22.2, 22.1, 22.1, 22.0, 21.9, 21.9, 21.8, 21.8, 21.7, 21.7, 21.7, 21.7, 21.7, 21.7, 21.8, 21.9, 22.0, 22.1, 22.1, 22.2, 22.4, 22.5, 22.7, 22.8, 23.0, 23.1, 23.3, 23.4, 23.5, 23.5, 23.6, 23.7, 23.8, 23.8, 23.9, 24.0, 24.1, 24.2, 24.3, 24.4, 24.6, 24.7, 24.8, 24.9, 25.1, 25.3, 25.4, 25.6, 25.7, 25.9, 26.1, 26.3, 26.6, 26.9, 27.2, 27.4, 27.7, 28.0, 28.3, 28.6, 28.9, 29.2, 29.5, 29.7, 30.0, 30.3, 30.6, 30.9, 31.2, 31.5, 31.9, 32.2, 32.5, 32.8]], "tmp2m": [29.32]}';
  </script>

  <pre id="errors" style="color: red; background-color: orange;"></pre>

  <!-- We'll use the whole browser viewport height. viewBox will be set dinamically depending on the number of barbs to display. -->
  <svg version="1.1" xmlns="http://www.w3.org/2000/svg" id="graph" height="100vh" style="background-color: white;">
    <style>
      #altitude {
        stroke: darkblue;
        stroke-width: 5;
      }
      #ground {
        stroke-width: 0;
        fill: brown;
      }
      .barb {
        fill: none;
        stroke: black;
        stroke-width: 5;
        stroke-linecap: round;
      }
    </style>
    <defs>
      <circle id="barb0" class="barb" cx=50 cy=50 r=10 />
      <path id="barb5" class="barb" d="M 50 80 L 50 10 M 50 70 L 40 75"/>
      <path id="barb10" class="barb" d="M 50 80 L 50 10 M 50 80 L 30 90"/>
      <path id="barb15" class="barb" d="M 50 80 L 50 10 M 50 80 L 30 90 M 50 70 L 40 75"/>
      <path id="barb20" class="barb" d="M 50 80 L 50 10 M 50 80 L 30 90 M 50 70 L 30 80"/>
      <path id="barb25" class="barb" d="M 50 80 L 50 10 M 50 80 L 30 90 M 50 70 L 30 80 M 50 60 L 40 65"/>
      <path id="barb30" class="barb" d="M 50 80 L 50 10 M 50 80 L 30 90 M 50 70 L 30 80 M 50 60 L 30 70"/>
      <path id="barb35" class="barb" d="M 50 80 L 50 10 M 50 80 L 30 90 M 50 70 L 30 80 M 50 60 L 30 70 M 50 50 L 40 55"/>
      <path id="barb40" class="barb" d="M 50 80 L 50 10 M 50 80 L 30 90 M 50 70 L 30 80 M 50 60 L 30 70 M 50 50 L 30 60"/>
      <path id="barb45" class="barb" d="M 50 80 L 50 10 M 50 80 L 30 90 M 50 70 L 30 80 M 50 60 L 30 70 M 50 50 L 30 60 M 50 40 L 40 45"/>
      <path id="barb50" class="barb" d="M 50 80 L 50 10 M 50 80 L 30 80 L 50 65"/>
    </defs>
    <rect id="ground" x=0 y=1000 width=100 height=1000 />
    <line id="altitude" x1=0 y1=0 x2=100 y2=0 />
  </svg>

  <script type="module">

    // Utils /////////////////////////////////////////////////////////////////

    function sum(arr) {
      return arr.reduce((acc, n) => acc + n, 0);
    }
 
    function average(arr) {
      return sum(arr) / arr.length;
    }

    function degToRad(deg) {
      return deg * (Math.PI/180)
    }

    // Adapted from https://rosettacode.org/wiki/Averages/Mean_angle
    function meanAngleDeg(a) {
      const floatMean = 180 / Math.PI * Math.atan2(
        sum(a.map(degToRad).map(Math.sin)) / a.length,
        sum(a.map(degToRad).map(Math.cos)) / a.length
      );
      // my additions
      const normFloatMean = ((floatMean % 360) + 360) % 360; // constrain to be between 0 and 360
      return Math.round(normFloatMean);
    }

    // From https://stackoverflow.com/questions/18883601/function-to-calculate-distance-between-two-coordinates
    function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
      var R = 6371; // Radius of the earth in km
      var dLat = degToRad(lat2-lat1);
      var dLon = degToRad(lon2-lon1); 
      var a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(degToRad(lat1)) * Math.cos(degToRad(lat2)) * 
        Math.sin(dLon/2) * Math.sin(dLon/2)
        ; 
      var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
      var d = R * c; // Distance in km
      return d;
    }

    function getQueryParam(paramName) {
      const queryParams = new URLSearchParams(window.location.search);
      const value = queryParams.get(paramName);
      if (!(typeof value === 'string' || value instanceof String)) {
        throw new Error(`Query parameter '${paramName}' is required.`);
      }
      return value;       
    }

    // Geopos ////////////////////////////////////////////////////////////////

    function getGeopos() {
      return new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(resolve, reject, {
          enableHighAccuracy: true,
          maximumAge: 10000
        });
      });
    }

    function onGeoposDepartFrom(lat, long, distKm, fun) {
      navigator.geolocation.watchPosition((geopos) => {
        const newCoords = geopos.coords;
        if (getDistanceFromLatLonInKm(lat, long, newCoords.latitude, newCoords.longitude) >= distKm) {
          fun(geopos);
        }
      }, (error) => {
        throw error;
      }, {
        enableHighAccuracy: true,
        maximumAge: 10000
      });
    }

    // UI ////////////////////////////////////////////////////////////////////

    function yCoordFromAltitude(altitude, topAltitude, viewBoxHeight) {
      return (topAltitude - altitude) * (viewBoxHeight / topAltitude)
    }

    function displayBarb(position, windSpeed, windDirection) {
      const graph = document.getElementById("graph");
      const barb = document.createElementNS("http://www.w3.org/2000/svg", "use");
      const y = position * 100;
      const windSpeedClass = `#barb${Math.min(Math.round(windSpeed / 5) * 5, 50)}`;
      barb.setAttributeNS(null, "x", 0);
      barb.setAttributeNS(null, "y", y);
      barb.setAttributeNS(null, "transform", `rotate(${windDirection} 50 ${y + 50})`);
      barb.setAttributeNS(null, "href", windSpeedClass);
      graph.appendChild(barb);
    }

    function updateAltitude(altitude, topAltitude, viewBoxHeight) {
      const altMarker = document.getElementById("altitude");
      const y = yCoordFromAltitude(altitude, topAltitude, viewBoxHeight);
      altMarker.setAttributeNS(null, "y1", y);
      altMarker.setAttributeNS(null, "y2", y);
    }

    function updateGroundHeight(groundAltitude, topAltitude, viewBoxHeight) {
      const groundBox = document.getElementById("ground");
      const y = yCoordFromAltitude(groundAltitude, topAltitude, viewBoxHeight);
      groundBox.setAttributeNS(null, "y", y);
    }

    // XCSkies ///////////////////////////////////////////////////////////////

    async function fetchXcskiesSkewTData(time, lat, lon, model) {
      const pad2 = (n) => ("0" + n).slice(-2);
      const dateStr = `${time.getUTCFullYear()}${pad2(time.getUTCMonth()+1)}${pad2(time.getDate())}`;
      const hourStr = pad2(time.getUTCHours());
      const url = `https://n3.xcskies.com/skewt/${model}/${dateStr}/${hourStr}/00?lat=${lat}&lon=${lon}&single=1&callback=d3.jsonp.zUiFTSuVvVHCoym`;
      const response = await fetch(url);
      const body = await response.text();
      const jsonData = body.slice(25, -1); // Remove JSONP wrapper function
      // const jsonData = STUB_SKEWT_DATA;
      return JSON.parse(jsonData);
    }

    function xcskiesSkewtDataToDisplayData(xcskiesSkewtData, numBarbs, barbAltRange) {
      const topAltitude = numBarbs * barbAltRange;

      // Iterate on all datapoints to get data by barb
      const rawBarbData = [];
      xcskiesSkewtData.hgts.every((altitude, i) => {
        if (altitude >= topAltitude) return false;
        const position = Math.floor(numBarbs - 1 - (altitude / barbAltRange));
        rawBarbData[position] ||= {windSpeeds: [], windDirs: []};
        rawBarbData[position].windSpeeds.push(xcskiesSkewtData.wspd[0][i] * 1.852); // in kph (orig in knots)
        rawBarbData[position].windDirs.push(xcskiesSkewtData.wdir[0][i]); // in degrees
        return true;
      });

      // Iterate by barb and calculate metadata
      const barbData = rawBarbData.map((barbDatum, position) => {
        return {
          meanWindSpeed: average(barbDatum.windSpeeds),
          meanWindDir: meanAngleDeg(barbDatum.windDirs)
        }
      });

      return {
        barbData,
        groundHeight: xcskiesSkewtData.shgt
      };
    }

    // Main //////////////////////////////////////////////////////////////////

    try {
      // Get URL query params
      // General
      const topAltitude = parseInt(getQueryParam("top")); // Top altitude (amsl) displayed eg. 5000
      const numBarbs = parseInt(getQueryParam("barbs")); // Number of barbs to display eg. 10
      // XCSkies
      const model = getQueryParam("model"); // Meteo model eg. iconeu, gfs...

      // Initialize graph
      const viewBoxHeight = 100 * numBarbs; // 100 units per barb in vp height
      const graph = document.getElementById("graph");
      graph.setAttributeNS(null, "viewBox", `0 0 100 ${viewBoxHeight}`);

      // Get current geoposition
      const geopos = await getGeopos();
      const coords = geopos.coords;

      // Retrieve and parse SkewT data
      const barbAltRange = topAltitude / numBarbs;
      const xcskiesSkewTData = await fetchXcskiesSkewTData(new Date(), coords.latitude, coords.longitude, model);
      const displayData = xcskiesSkewtDataToDisplayData(xcskiesSkewTData, numBarbs, barbAltRange)

      // Display all data //

      displayData.barbData.forEach((barbDatum, position) => {
        displayBarb(position, barbDatum.meanWindSpeed, barbDatum.meanWindDir);
      });

      updateAltitude(coords.altitude, topAltitude, viewBoxHeight);

      updateGroundHeight(displayData.groundHeight, topAltitude, viewBoxHeight);

      // Set reload strategies to refresh displayed data
      const reload = ()=>{ window.location.reload(); };
      onGeoposDepartFrom(coords.latitude, coords.longitude, 1, reload);
      setTimeout(reload, 40 * 60 * 1000);

    } catch (error) {
      const div = document.getElementById("errors");
      div.innerHTML += error.message;
      throw error;
    }
  </script>
</body>
</html>

