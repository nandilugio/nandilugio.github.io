<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Vario Widget</title>
  <style>
    * {    
      margin: 0 !important;
      padding: 0 !important;
    }
    body {
      background-color: #eee;
    }
  </style>
</head>

<body>
  <script>
    // TODO: remove
    // 1: Cloudy Penestin Aug-11 at 14 47.48465642327034,-2.4983167648315434
    const STUB_SKEWT_DATA = '{"dalrtops": [[200.0, 993.4, 18.39]], "uid": "fzzqVvmICCaMqtY", "wdir": [[44.7, 43.4, 44.1, 45.7, 47.3, 49.2, 51.1, 50.9, 50.5, 51.0, 51.7, 52.7, 54.0, 55.4, 56.6, 57.6, 58.6, 59.0, 59.2, 59.3, 59.9, 61.1, 62.3, 63.6, 64.7, 65.8, 66.8, 67.5, 67.8, 68.1, 68.3, 68.6, 68.7, 68.8, 68.9, 68.9, 69.0, 69.0, 69.0, 69.1, 69.0, 69.0, 69.0, 68.9, 69.1, 69.3, 69.5, 69.7, 69.9, 70.1, 70.4, 70.6, 70.8, 71.0, 70.9, 70.8, 70.7, 70.6, 70.5, 70.2, 69.9, 69.5, 69.2, 68.8, 68.4, 67.8, 67.2, 66.7, 66.1, 65.6, 64.7, 63.9, 63.0, 62.2, 61.3, 60.6, 60.3, 60.0, 59.7, 59.5, 59.2, 59.1, 59.3, 59.5, 59.7, 59.9, 60.1, 60.2, 60.0, 59.9, 59.7, 59.6, 59.4, 59.2, 58.9, 58.6, 58.4, 58.1, 57.8, 57.4, 57.1, 56.8, 56.4, 56.1, 55.7, 55.6, 56.0, 56.5, 56.9, 57.4, 57.9, 58.4, 58.7, 59.1, 59.5, 59.9, 60.3, 60.5, 60.0, 59.6, 59.1, 58.7, 58.2, 57.5, 56.4, 55.3, 54.3, 53.2, 52.1, 51.0, 49.8, 48.6, 47.4, 46.2, 45.1, 44.3, 44.5, 44.8, 45.0, 45.2, 45.5, 45.8, 46.2, 46.7, 47.1, 47.6, 48.1, 48.4, 48.4, 48.4, 48.3, 48.3, 48.3, 48.3, 48.4, 48.4, 48.5, 48.6, 48.7, 48.8, 49.2, 49.6, 50.0, 50.4, 50.8, 51.0, 51.0, 51.0, 51.0, 50.9, 50.9, 50.7, 50.2, 49.6, 49.0, 48.5, 47.9, 47.5, 47.5, 47.5, 47.6, 47.6, 47.6, 47.8, 48.5, 49.1, 49.8, 50.4, 51.1, 51.6, 51.9, 52.1, 52.4, 52.7, 52.9, 53.1, 53.2, 53.2, 53.3, 53.3, 53.4, 53.3, 53.0, 52.7, 52.3, 52.0, 51.7, 51.5, 51.6, 51.6, 51.6, 51.6, 51.6, 51.6, 51.6, 51.6, 51.6, 51.5, 51.5, 51.5, 51.5, 51.4, 51.4, 51.4, 51.4, 51.3, 51.2, 51.0, 50.8]], "hgts": [0.0, 50.0, 100.0, 150.0, 200.0, 250.0, 300.0, 350.0, 400.0, 450.0, 500.0, 550.0, 600.0, 650.0, 700.0, 750.0, 800.0, 850.0, 900.0, 950.0, 1000.0, 1050.0, 1100.0, 1150.0, 1200.0, 1250.0, 1300.0, 1350.0, 1400.0, 1450.0, 1500.0, 1550.0, 1600.0, 1650.0, 1700.0, 1750.0, 1800.0, 1850.0, 1900.0, 1950.0, 2000.0, 2050.0, 2100.0, 2150.0, 2200.0, 2250.0, 2300.0, 2350.0, 2400.0, 2450.0, 2500.0, 2550.0, 2600.0, 2650.0, 2700.0, 2750.0, 2800.0, 2850.0, 2900.0, 2950.0, 3000.0, 3050.0, 3100.0, 3150.0, 3200.0, 3250.0, 3300.0, 3350.0, 3400.0, 3450.0, 3500.0, 3550.0, 3600.0, 3650.0, 3700.0, 3750.0, 3800.0, 3850.0, 3900.0, 3950.0, 4000.0, 4050.0, 4100.0, 4150.0, 4200.0, 4250.0, 4300.0, 4350.0, 4400.0, 4450.0, 4500.0, 4550.0, 4600.0, 4650.0, 4700.0, 4750.0, 4800.0, 4850.0, 4900.0, 4950.0, 5000.0, 5050.0, 5100.0, 5150.0, 5200.0, 5250.0, 5300.0, 5350.0, 5400.0, 5450.0, 5500.0, 5550.0, 5600.0, 5650.0, 5700.0, 5750.0, 5800.0, 5850.0, 5900.0, 5950.0, 6000.0, 6050.0, 6100.0, 6150.0, 6200.0, 6250.0, 6300.0, 6350.0, 6400.0, 6450.0, 6500.0, 6550.0, 6600.0, 6650.0, 6700.0, 6750.0, 6800.0, 6850.0, 6900.0, 6950.0, 7000.0, 7050.0, 7100.0, 7150.0, 7200.0, 7250.0, 7300.0, 7350.0, 7400.0, 7450.0, 7500.0, 7550.0, 7600.0, 7650.0, 7700.0, 7750.0, 7800.0, 7850.0, 7900.0, 7950.0, 8000.0, 8050.0, 8100.0, 8150.0, 8200.0, 8250.0, 8300.0, 8350.0, 8400.0, 8450.0, 8500.0, 8550.0, 8600.0, 8650.0, 8700.0, 8750.0, 8800.0, 8850.0, 8900.0, 8950.0, 9000.0, 9050.0, 9100.0, 9150.0, 9200.0, 9250.0, 9300.0, 9350.0, 9400.0, 9450.0, 9500.0, 9550.0, 9600.0, 9650.0, 9700.0, 9750.0, 9800.0, 9850.0, 9900.0, 9950.0, 10000.0, 10050.0, 10100.0, 10150.0, 10200.0, 10250.0, 10300.0, 10350.0, 10400.0, 10450.0, 10500.0, 10550.0, 10600.0, 10650.0, 10700.0, 10750.0, 10800.0, 10850.0, 10900.0, 10950.0, 11000.0, 11050.0, 11100.0, 11150.0, 11200.0, 11250.0, 11300.0, 11350.0, 11400.0], "press": [[1019, 1013, 1006, 1000, 993, 987, 981, 975, 969, 963, 957, 951, 945, 940, 934, 928, 923, 917, 911, 906, 900, 895, 890, 884, 879, 873, 868, 863, 858, 852, 847, 842, 837, 832, 827, 822, 817, 812, 807, 802, 797, 792, 787, 782, 778, 773, 768, 763, 759, 754, 749, 745, 740, 736, 731, 727, 722, 718, 713, 709, 704, 700, 696, 691, 687, 683, 679, 674, 670, 666, 662, 658, 654, 650, 645, 641, 637, 634, 630, 626, 622, 618, 614, 610, 606, 603, 599, 595, 591, 588, 584, 580, 577, 573, 570, 566, 562, 559, 555, 552, 548, 545, 541, 538, 535, 531, 528, 524, 521, 518, 514, 511, 508, 505, 501, 498, 495, 492, 489, 485, 482, 479, 476, 473, 470, 467, 464, 461, 458, 455, 452, 449, 446, 443, 440, 437, 434, 431, 428, 426, 423, 420, 417, 414, 412, 409, 406, 403, 401, 398, 395, 393, 390, 387, 385, 382, 380, 377, 374, 372, 369, 367, 364, 362, 359, 357, 354, 352, 350, 347, 345, 342, 340, 338, 335, 333, 331, 328, 326, 324, 322, 319, 317, 315, 313, 310, 308, 306, 304, 302, 299, 297, 295, 293, 291, 289, 287, 285, 283, 281, 279, 276, 274, 273, 271, 269, 267, 265, 263, 261, 259, 257, 255, 253, 251, 249, 248, 246, 244, 242, 240, 238, 237, 235, 233, 231, 230, 228, 226]], "tmps": [[19.99, 19.48, 18.96, 18.58, 18.39, 18.27, 18.18, 17.97, 17.75, 17.49, 17.21, 16.95, 16.75, 16.54, 16.31, 16.07, 15.84, 15.57, 15.29, 15.01, 14.77, 14.56, 14.36, 14.15, 13.9, 13.65, 13.4, 13.17, 12.96, 12.75, 12.54, 12.33, 12.12, 11.91, 11.7, 11.49, 11.27, 11.05, 10.84, 10.62, 10.39, 10.17, 9.95, 9.72, 9.49, 9.26, 9.03, 8.79, 8.56, 8.38, 8.2, 8.03, 7.85, 7.68, 7.42, 7.15, 6.88, 6.61, 6.34, 6.08, 5.82, 5.56, 5.3, 5.05, 4.8, 4.57, 4.33, 4.1, 3.87, 3.63, 3.37, 3.1, 2.83, 2.57, 2.3, 2.03, 1.76, 1.49, 1.21, 0.94, 0.67, 0.4, 0.14, -0.11, -0.37, -0.63, -0.88, -1.15, -1.46, -1.76, -2.07, -2.37, -2.67, -2.94, -3.11, -3.28, -3.45, -3.61, -3.78, -3.97, -4.24, -4.5, -4.76, -5.02, -5.28, -5.56, -5.89, -6.22, -6.55, -6.88, -7.21, -7.54, -7.89, -8.24, -8.59, -8.94, -9.29, -9.66, -10.05, -10.44, -10.84, -11.23, -11.62, -12.0, -12.35, -12.7, -13.05, -13.4, -13.75, -14.09, -14.4, -14.7, -15.01, -15.31, -15.62, -15.89, -16.1, -16.3, -16.51, -16.71, -16.91, -17.12, -17.33, -17.55, -17.76, -17.97, -18.19, -18.46, -18.88, -19.31, -19.73, -20.16, -20.58, -20.98, -21.31, -21.64, -21.97, -22.3, -22.63, -22.97, -23.32, -23.66, -24.01, -24.36, -24.71, -25.1, -25.58, -26.06, -26.55, -27.03, -27.51, -27.96, -28.32, -28.69, -29.05, -29.42, -29.78, -30.14, -30.47, -30.8, -31.14, -31.47, -31.8, -32.15, -32.54, -32.93, -33.31, -33.7, -34.09, -34.48, -34.88, -35.28, -35.68, -36.08, -36.48, -36.88, -37.27, -37.67, -38.07, -38.47, -38.87, -39.25, -39.62, -39.99, -40.36, -40.73, -41.1, -41.48, -41.9, -42.32, -42.73, -43.15, -43.57, -43.97, -44.35, -44.74, -45.12, -45.5, -45.88, -46.26, -46.63, -47.0, -47.37, -47.73, -48.1, -48.48, -48.88, -49.28, -49.68]], "dates": [1691755200.0], "dps": [[19.1, 18.9, 18.8, 18.6, 18.3, 18.1, 17.8, 17.5, 17.1, 16.8, 16.6, 16.3, 16.2, 16.0, 15.8, 15.6, 15.4, 15.2, 15.0, 14.9, 14.7, 14.5, 14.3, 14.1, 13.8, 13.6, 13.4, 13.1, 12.9, 12.7, 12.5, 12.3, 12.1, 11.9, 11.7, 11.5, 11.3, 11.0, 10.8, 10.6, 10.4, 10.2, 9.9, 9.7, 9.5, 9.2, 9.0, 8.8, 8.5, 8.3, 8.0, 7.8, 7.5, 7.2, 6.9, 6.6, 6.3, 6.0, 5.7, 5.5, 5.2, 4.9, 4.6, 4.4, 4.0, 3.5, 2.9, 2.4, 1.9, 1.3, 1.0, 0.7, 0.4, 0.0, -0.3, -0.6, -0.9, -1.2, -1.5, -1.9, -2.2, -2.4, -2.5, -2.6, -2.7, -2.8, -3.0, -3.3, -4.4, -5.5, -6.6, -7.8, -9.0, -10.3, -11.5, -12.8, -14.1, -15.6, -17.3, -18.5, -18.0, -17.6, -17.2, -16.8, -16.4, -16.1, -15.6, -15.2, -14.9, -14.5, -14.2, -14.0, -14.0, -14.0, -14.0, -14.0, -14.0, -14.1, -14.3, -14.4, -14.6, -14.8, -15.0, -15.2, -15.4, -15.7, -15.9, -16.1, -16.4, -16.6, -16.6, -16.7, -16.8, -16.9, -17.0, -17.1, -17.3, -17.6, -17.8, -18.0, -18.3, -18.6, -19.3, -20.0, -20.7, -21.5, -22.2, -23.0, -23.7, -24.4, -25.1, -25.9, -26.6, -27.4, -28.5, -29.6, -30.7, -32.0, -33.2, -34.3, -34.5, -34.7, -35.0, -35.2, -35.4, -35.6, -35.7, -35.8, -36.0, -36.1, -36.2, -36.5, -37.1, -37.6, -38.2, -38.8, -39.3, -40.0, -40.9, -41.7, -42.7, -43.6, -44.6, -45.3, -45.4, -45.6, -45.7, -45.8, -45.9, -46.2, -46.6, -47.1, -47.5, -47.9, -48.4, -48.9, -49.5, -50.1, -50.7, -51.4, -52.0, -52.6, -53.1, -53.6, -54.1, -54.6, -55.1, -55.6, -56.0, -56.5, -56.9, -57.4, -57.8, -58.2, -58.4, -58.7, -58.9, -59.2, -59.4, -59.6, -59.5, -59.5, -59.5, -59.5, -59.5, -59.5, -59.5, -59.6, -59.6]], "shgt": 5.0, "spress": [1021.7], "wspd": [[7.1, 7.8, 8.8, 9.7, 10.6, 11.5, 12.3, 12.4, 12.4, 12.4, 12.2, 12.0, 11.6, 11.2, 11.0, 10.8, 10.6, 10.4, 10.2, 9.9, 9.8, 9.7, 9.6, 9.5, 9.6, 9.7, 9.8, 9.9, 9.9, 9.9, 10.0, 10.1, 10.2, 10.3, 10.5, 10.6, 10.6, 10.6, 10.6, 10.7, 10.9, 11.1, 11.3, 11.5, 11.6, 11.8, 11.9, 12.0, 12.1, 12.6, 13.1, 13.6, 14.0, 14.5, 14.8, 15.0, 15.3, 15.5, 15.8, 16.0, 16.1, 16.3, 16.5, 16.6, 16.8, 17.0, 17.2, 17.4, 17.5, 17.7, 17.8, 17.8, 17.8, 17.8, 17.8, 17.9, 18.1, 18.4, 18.6, 18.9, 19.1, 19.3, 19.4, 19.6, 19.7, 19.8, 19.9, 20.0, 20.0, 20.1, 20.1, 20.1, 20.1, 20.1, 19.9, 19.8, 19.6, 19.5, 19.3, 19.2, 19.2, 19.1, 19.1, 19.1, 19.1, 19.0, 18.8, 18.6, 18.4, 18.2, 18.0, 17.8, 17.6, 17.4, 17.2, 17.0, 16.8, 16.7, 16.7, 16.6, 16.6, 16.6, 16.5, 16.5, 16.6, 16.7, 16.8, 16.9, 17.0, 17.2, 17.3, 17.5, 17.6, 17.8, 18.0, 18.1, 18.0, 17.9, 17.8, 17.7, 17.6, 17.5, 17.4, 17.3, 17.2, 17.1, 17.0, 17.0, 17.5, 17.9, 18.4, 18.9, 19.3, 19.6, 19.7, 19.7, 19.8, 19.8, 19.9, 20.0, 20.1, 20.2, 20.3, 20.5, 20.6, 20.7, 20.7, 20.7, 20.6, 20.6, 20.6, 20.6, 20.6, 20.5, 20.5, 20.4, 20.4, 20.4, 20.7, 20.9, 21.2, 21.5, 21.7, 21.9, 21.9, 22.0, 22.0, 22.0, 22.0, 22.1, 22.2, 22.4, 22.5, 22.7, 22.8, 23.0, 23.2, 23.4, 23.6, 23.9, 24.1, 24.3, 24.4, 24.6, 24.7, 24.8, 25.0, 25.1, 25.1, 25.1, 25.1, 25.1, 25.1, 25.2, 25.3, 25.4, 25.6, 25.7, 25.8, 25.9, 25.9, 25.9, 25.9, 25.9, 25.9, 25.9, 26.0, 26.1, 26.1]], "tmp2m": [20.36]}';
  </script>

  <pre id="errors" style="color: red; background-color: orange;"></pre>

  <!-- The size of the barbs is 100x100, see paths. This is assumed thruought the whole code. Magic number... ¯\_(ツ)_/¯ -->
  <!-- We'll use the whole browser viewport height. viewBox height will be set dinamically = numBarbs * 100. -->
  <svg version="1.1" xmlns="http://www.w3.org/2000/svg" id="graph" height="100vh" style="background-color: white;">
    <style>
      #instability-gradient {
        stroke-width: 0;
      }
      #altitude {
        stroke: darkblue;
        stroke-width: 5;
      }
      #ground {
        stroke-width: 0;
        fill: brown;
      }
      .barb {
        fill: none;
        stroke: black;
        stroke-width: 5;
        stroke-linecap: round;
      }
    </style>
    <defs>
      <circle id="barb-tpl0" class="barb" cx=50 cy=50 r=10 />
      <path id="barb-tpl5" class="barb" d="M 50 80 L 50 10 M 50 70 L 40 75"/>
      <path id="barb-tpl10" class="barb" d="M 50 80 L 50 10 M 50 80 L 30 90"/>
      <path id="barb-tpl15" class="barb" d="M 50 80 L 50 10 M 50 80 L 30 90 M 50 70 L 40 75"/>
      <path id="barb-tpl20" class="barb" d="M 50 80 L 50 10 M 50 80 L 30 90 M 50 70 L 30 80"/>
      <path id="barb-tpl25" class="barb" d="M 50 80 L 50 10 M 50 80 L 30 90 M 50 70 L 30 80 M 50 60 L 40 65"/>
      <path id="barb-tpl30" class="barb" d="M 50 80 L 50 10 M 50 80 L 30 90 M 50 70 L 30 80 M 50 60 L 30 70"/>
      <path id="barb-tpl35" class="barb" d="M 50 80 L 50 10 M 50 80 L 30 90 M 50 70 L 30 80 M 50 60 L 30 70 M 50 50 L 40 55"/>
      <path id="barb-tpl40" class="barb" d="M 50 80 L 50 10 M 50 80 L 30 90 M 50 70 L 30 80 M 50 60 L 30 70 M 50 50 L 30 60"/>
      <path id="barb-tpl45" class="barb" d="M 50 80 L 50 10 M 50 80 L 30 90 M 50 70 L 30 80 M 50 60 L 30 70 M 50 50 L 30 60 M 50 40 L 40 45"/>
      <path id="barb-tpl50" class="barb" d="M 50 80 L 50 10 M 50 80 L 30 80 L 50 65"/>
    </defs>
    <linearGradient id="condensation-clouds-gradient" gradientTransform="rotate(90)" />
    <linearGradient id="instability-gradient" gradientTransform="rotate(90)" />
    <rect id="condensation-clouds-box" x=0 y=0 width=25 height=0 fill="url(#condensation-clouds-gradient)" />
    <rect id="instability-box" x=25 y=0 width=50 height=0 fill="url(#instability-gradient)" />
    <rect id="ground" x=0 y=1000 width=100 height=0 />
    <line id="altitude" x1=0 y1=0 x2=100 y2=0 />
  </svg>

  <script type="module">

    // Utils /////////////////////////////////////////////////////////////////

    // Arithmetic

    function sum(arr) {
      return arr.reduce((acc, n) => acc + n, 0);
    }
 
    function mean(arr) {
      return sum(arr) / arr.length;
    }

    // Geo

    function degToRad(deg) {
      return deg * (Math.PI / 180)
    }

    // Adapted from https://rosettacode.org/wiki/Averages/Mean_angle
    function meanAngleDeg(a) {
      const floatMean = 180 / Math.PI * Math.atan2(
        sum(a.map(degToRad).map(Math.sin)) / a.length,
        sum(a.map(degToRad).map(Math.cos)) / a.length
      );
      // my additions
      const normFloatMean = ((floatMean % 360) + 360) % 360; // constrain to be between 0 and 360
      return Math.round(normFloatMean);
    }

    // From https://stackoverflow.com/questions/18883601/function-to-calculate-distance-between-two-coordinates
    function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
      var R = 6371; // Radius of the earth in km
      var dLat = degToRad(lat2-lat1);
      var dLon = degToRad(lon2-lon1); 
      var a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(degToRad(lat1)) * Math.cos(degToRad(lat2)) * 
        Math.sin(dLon/2) * Math.sin(dLon/2)
        ; 
      var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
      var d = R * c; // Distance in km
      return d;
    }

    // UI

    // From https://stackoverflow.com/a/30144587
    // TODO: is it backwards?
    function gradientSample(color1, color2, weight) {
      var w1 = weight;
      var w2 = 1 - w1;
      var rgb = [Math.round(color1[0] * w1 + color2[0] * w2),
          Math.round(color1[1] * w1 + color2[1] * w2),
          Math.round(color1[2] * w1 + color2[2] * w2)];
      return rgb;
    }


    // HTTP

    function getQueryParam(paramName) {
      const queryParams = new URLSearchParams(window.location.search);
      const value = queryParams.get(paramName);
      if (!(typeof value === 'string' || value instanceof String)) {
        throw new Error(`Query parameter '${paramName}' is required.`);
      }
      return value;       
    }

    // Geopos ////////////////////////////////////////////////////////////////

    function getGeopos() {
      return new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(resolve, reject, {
          enableHighAccuracy: true,
          maximumAge: 10000
        });
      });
    }

    function onGeoposDepartFrom(lat, long, distKm, fun) {
      navigator.geolocation.watchPosition((geopos) => {
        const newCoords = geopos.coords;
        if (getDistanceFromLatLonInKm(lat, long, newCoords.latitude, newCoords.longitude) >= distKm) {
          fun(geopos);
        }
      }, (error) => {
        throw error;
      }, {
        enableHighAccuracy: true,
        maximumAge: 10000
      });
    }

    // XCSkies ///////////////////////////////////////////////////////////////

    async function fetchXcskiesSkewTData(time, lat, lon, model) {
      const pad2 = (n) => ("0" + n).slice(-2);
      const dateStr = `${time.getUTCFullYear()}${pad2(time.getUTCMonth()+1)}${pad2(time.getDate())}`;
      const hourStr = pad2(time.getUTCHours());
      const url = `https://n3.xcskies.com/skewt/${model}/${dateStr}/${hourStr}/00?lat=${lat}&lon=${lon}&single=1&callback=d3.jsonp.zUiFTSuVvVHCoym`;
      // const response = await fetch(url);
      // const body = await response.text();
      // const jsonData = body.slice(25, -1); // Remove JSONP wrapper function
      const jsonData = STUB_SKEWT_DATA;
      return JSON.parse(jsonData);
    }

    function xcskiesSkewTDataToDisplayData(xcskiesSkewtData, numBarbs, barbAltRange) {
      const topAltitude = numBarbs * barbAltRange;

      // Iterate on all datapoints to get data by barb, instability data, etc.
      var lastAlt = null;
      var lastTemp = null;
      const firstProcessingPassData = xcskiesSkewtData.hgts.reduce((acc, altitude, i) => {
        if (altitude >= topAltitude) return acc;
        if (altitude <= 0) return acc; // Just in case...

        // Wind (barbs)
        const barbIdx = Math.floor(numBarbs - (altitude / barbAltRange)); // 0 based idx from top (SVG coords style)
        acc.barbs[barbIdx] ||= {windSpeeds: [], windDirs: []};
        acc.barbs[barbIdx].windSpeeds.push(xcskiesSkewtData.wspd[0][i] * 1.852); // in kph (orig in knots)
        acc.barbs[barbIdx].windDirs.push(xcskiesSkewtData.wdir[0][i]); // in degrees
        
        // Instability
        const currentTemp = xcskiesSkewtData.tmps[0][i];
        if (lastAlt) {
          // We assume altitudes ordered low to high
          const deltaAlt = altitude - lastAlt; // In m, always positive
          const deltaTemp = currentTemp - lastTemp; // Change while rising in C, normally negative (positive means inversion)
          const lapseRate = (deltaTemp / deltaAlt) * 1000; // C/km
          acc.instabilityByAlt.push([altitude, lapseRate]); // the value corresponds to the range between altitude and lastAlt below it
        }
        lastAlt = altitude;
        lastTemp = currentTemp;

        // Non-convective Cloud Cover
        // Loose interpretation of https://flsc.org/portals/12/PDF/Read_Skew_T.pdf
        // TODO: Are these the right calculations?
        const MIN_NONCONV_CLOUD_COVER_TEMP_DIFF = 3; // C
        const tempDiffToDewPoint = xcskiesSkewtData.tmps[0][i] - xcskiesSkewtData.dps[0][i];
        const cloudCover = tempDiffToDewPoint > MIN_NONCONV_CLOUD_COVER_TEMP_DIFF ? 0 :
          (MIN_NONCONV_CLOUD_COVER_TEMP_DIFF - tempDiffToDewPoint) * 100 / MIN_NONCONV_CLOUD_COVER_TEMP_DIFF; // in %
        acc.nonConvCloudCoverByAlt.push([altitude, cloudCover]); // the value corresponds to the range between altitude and lastAlt below it

        return acc;
      }, { barbs: [], instabilityByAlt: [], nonConvCloudCoverByAlt: [] });

      // Iterate by barb and calculate metadata
      const barbData = firstProcessingPassData.barbs.map((barbDatum, position) => {
        return {
          meanWindSpeed: mean(barbDatum.windSpeeds),
          meanWindDir: meanAngleDeg(barbDatum.windDirs)
        }
      });

      return {
        barbData, // Array of {meanWindSpeed in kph, meanWindDir in degrees}, top to bottom
        instabilityByAlt: firstProcessingPassData.instabilityByAlt, // Array of [altitude in m, lapseRate in C/km] each one corresponding to the range between altitude and the last one below it
        nonConvCloudCoverByAlt: firstProcessingPassData.nonConvCloudCoverByAlt, // Array of [altitude in m, cloud cover in %] each one corresponding to the range between altitude and the last one below it
        groundHeight: xcskiesSkewtData.shgt, // in m
      };
    }

    // UI ////////////////////////////////////////////////////////////////////
    // barbHeightInViewBox = 100                        // Follows barb path size in the SVG. Magic number... ¯\_(ツ)_/¯
    // barbAltRange = topAltitude / numBarbs            // 500 = 5000 / 10
    // viewBoxHeight = numBarbs * barbHeightInViewBox   // 1000 = 10 * 100

    function yCoordFromAltitude(altitude, topAltitude, viewBoxHeight) {
      return (topAltitude - altitude) * (viewBoxHeight / topAltitude);
    }

    function colorFromCloudCoverPercent(cloudCover) {
      const colorAt0 = [255,255,255]; // White
      const colorAt1 = [200,200,200]; // Visible enough gray
      const colorAt100 = [100,100,100]; // Dark gray
      if (cloudCover < 1) {
        return colorAt0;
      } else {
        return gradientSample(colorAt100, colorAt1, cloudCover / 100);
      }
    }

    function instabilityColorFromLapseRate(lapseRate) {
      // Meteo constants (will never change):
      //   Isotherm lapse rate: 0 C/Km
      //   Mean environmental lapse rate: -6.5 C/Km
      //   Dry adiabatic lapse rate: -9.8 C/Km

      const colorAtMaxInversion = [0,0,200]; // Dark blue
      const colorAtIsotherm = [0,200,200]; // Pale blue
      const colorAtMeanEnvLapseRate = [255,200,0]; // Yellow
      const colorAtDryAdiabat = [255,0,0]; // Red
      const colorAtMaxInstability = [100,0,0]; // Dark red

      const maxRelevantLapseRate = 10; // C/Km considered inpenetrable inversion
      if (lapseRate >= 10) { // (inf,10) Strong inversion
        return colorAtMaxInversion;
      } else if (lapseRate >= 0) { // [10,0) Inversion
        const colorBalance = (((lapseRate - maxRelevantLapseRate) / maxRelevantLapseRate) ** 3) + 1; // Just x^3 moved so f(0)=0 and f(10)=1. Note f(5)=0.88
        return gradientSample(colorAtMaxInversion, colorAtIsotherm, colorBalance);
      } else if (lapseRate >= -6.5) { // [0,-6.5) Stability
        const colorBalance = (lapseRate + 6.5) / 6.5; // f(0)=1, f(-6.5)=0
        return gradientSample(colorAtIsotherm, colorAtMeanEnvLapseRate, colorBalance);
      } else if (lapseRate >= -9.8) { // [-6.5,-9.8) Good soaring conditions
        const colorBalance = (lapseRate + 9.8) / 3.3; // f(-6.5)=1, f(-9.8)=0
        return gradientSample(colorAtMeanEnvLapseRate, colorAtDryAdiabat, colorBalance);
      } else { // [-9.8,-inf) High instability
        return colorAtMaxInstability;
      }
    }

    function updateNonConvCloudCover(nonConvCloudCoverByAlt, topAltitude, viewBoxHeight) {
      const gradient = document.getElementById("condensation-clouds-gradient");

      // Remove all old stops
      gradient.querySelectorAll('stop').forEach(e => e.parentNode.removeChild(e));

      // Create all new stops
      nonConvCloudCoverByAlt.reverse().forEach(([altitude, cloudCover]) => {
        const y = yCoordFromAltitude(altitude, topAltitude, viewBoxHeight);
        const gradientPercent = ((y / viewBoxHeight) * 100).toFixed(1);
        const color = colorFromCloudCoverPercent(cloudCover);
        const stop = document.createElementNS("http://www.w3.org/2000/svg", "stop");
        stop.setAttributeNS(null, "offset", `${gradientPercent}%`);
        stop.setAttributeNS(null, "stop-color", `rgb(${color.join(",")})`);
        gradient.appendChild(stop);
      });

      // Ensure the box height is initialized (actually only useful 1st time)
      const box = document.getElementById("condensation-clouds-box");
      box.setAttributeNS(null, "height", viewBoxHeight);
    }

    function updateInstability(instabilityByAlt, topAltitude, viewBoxHeight) {
      const gradient = document.getElementById("instability-gradient");

      // Remove all old stops
      gradient.querySelectorAll('stop').forEach(e => e.parentNode.removeChild(e));

      // Create all new stops
      instabilityByAlt.reverse().forEach(([altitude, lapseRate]) => {
        const y = yCoordFromAltitude(altitude, topAltitude, viewBoxHeight);
        const gradientPercent = ((y / viewBoxHeight) * 100).toFixed(1);
        const color = instabilityColorFromLapseRate(lapseRate);
        const stop = document.createElementNS("http://www.w3.org/2000/svg", "stop");
        stop.setAttributeNS(null, "offset", `${gradientPercent}%`);
        stop.setAttributeNS(null, "stop-color", `rgb(${color.join(",")})`);
        gradient.appendChild(stop);
      });

      // Ensure the box height is initialized (actually only useful 1st time)
      const box = document.getElementById("instability-box");
      box.setAttributeNS(null, "height", viewBoxHeight);
    }

    function updateBarbs(barbDisplayData) {
      const graph = document.getElementById("graph");
      
      // Remove all old barbs
      graph.querySelectorAll('.barb-instance').forEach(e => e.parentNode.removeChild(e));

      // Create all new barbs
      barbDisplayData.forEach((barbDatum, barbIdx) => {
        const barb = document.createElementNS("http://www.w3.org/2000/svg", "use");
        const y = barbIdx * 100;
        const windBucket = Math.min(Math.round(barbDatum.meanWindSpeed / 5) * 5, 50);
        const barbTplSelector = `#barb-tpl${windBucket}`;
        barb.setAttributeNS(null, "class", "barb-instance");
        barb.setAttributeNS(null, "x", 0);
        barb.setAttributeNS(null, "y", y);
        barb.setAttributeNS(null, "transform", `rotate(${barbDatum.meanWindDir} 50 ${y + 50})`);
        barb.setAttributeNS(null, "href", barbTplSelector);
        graph.appendChild(barb);
      });
    }

    function updateAltitude(altitude, topAltitude, viewBoxHeight) {
      const altMarker = document.getElementById("altitude");
      const y = yCoordFromAltitude(altitude, topAltitude, viewBoxHeight);
      altMarker.setAttributeNS(null, "y1", y);
      altMarker.setAttributeNS(null, "y2", y);
    }

    function updateGroundHeight(groundAltitude, topAltitude, viewBoxHeight) {
      const groundBox = document.getElementById("ground");
      const y = yCoordFromAltitude(groundAltitude, topAltitude, viewBoxHeight);
      groundBox.setAttributeNS(null, "height", viewBoxHeight - y);
      groundBox.setAttributeNS(null, "y", y);
    }

    // Main //////////////////////////////////////////////////////////////////

    try {
      // Get URL query params
      // General
      const topAltitude = parseInt(getQueryParam("top")); // Top altitude (amsl) displayed eg. 5000
      const numBarbs = parseInt(getQueryParam("barbs")); // Number of barbs to display eg. 10
      // XCSkies
      const model = getQueryParam("model"); // Meteo model eg. iconeu, gfs...

      // Initialize graph
      const viewBoxHeight = 100 * numBarbs; // 100 units per barb in vp height
      const graph = document.getElementById("graph");
      graph.setAttributeNS(null, "viewBox", `0 0 100 ${viewBoxHeight}`);

      // Get current geoposition
      const geopos = await getGeopos();
      const coords = geopos.coords;

      // Retrieve and parse SkewT data
      const barbAltRange = topAltitude / numBarbs;
      const xcskiesSkewTData = await fetchXcskiesSkewTData(new Date(), coords.latitude, coords.longitude, model);
      const displayData = xcskiesSkewTDataToDisplayData(xcskiesSkewTData, numBarbs, barbAltRange)

      // Display all data
      updateNonConvCloudCover(displayData.nonConvCloudCoverByAlt, topAltitude, viewBoxHeight)
      updateInstability(displayData.instabilityByAlt, topAltitude, viewBoxHeight);
      updateBarbs(displayData.barbData);
      updateAltitude(coords.altitude, topAltitude, viewBoxHeight);
      updateGroundHeight(displayData.groundHeight, topAltitude, viewBoxHeight);

      // Set reload strategies to refresh displayed data
      const reload = ()=>{ window.location.reload(); };
      onGeoposDepartFrom(coords.latitude, coords.longitude, 1, reload);
      setTimeout(reload, 40 * 60 * 1000);

    } catch (error) {
      const div = document.getElementById("errors");
      div.innerHTML += error.message;
      throw error;
    }
  </script>
</body>
</html>

